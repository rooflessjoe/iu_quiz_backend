<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: routes/login.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: routes/login.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Express router providing Login and Registration related routes
 * @module Login&amp;Registration
 * @requires module:PostgreSQL
 */

//Benötigte Module
const express = require('express');
const bcrypt = require('bcryptjs');
const jwt = require('jsonwebtoken');
const pool = require('../components/pool');

/**
 * Express router to mount login related functions on
 * @type {object}
 * @constant router
 * @namespace loginRouter
 */
const router = express.Router();

// Registrierung der Middleware zur Verarbeitung von JSON Anfragen
router.use(express.json());

// Authentifiziert einen Benutzer und gibt ein JSON Web Token zurück.
/**
 * Route providing the login authentification for the web application
 * @name post/login
 * @async
 * @function
 * @param {Object} req - Request object
 * @param {Object} res - Response object
 * @returns {Object} JSON Web Token
 * @memberof module:Login&amp;Registration~loginRouter
 * @inner
 */
router.post('/api/login', async (req, res) => {
  const { username, password } = req.body;
  try {
      const result = await pool.query(global.queries.login, [username]);
      const user = result.rows[0];
      
      // bcrypt.compare vergleicht das gehashte Passwort in der Datenbank mit dem übergebenen Passwort in Klartext
      if (user &amp;&amp; await bcrypt.compare(password, user.password)) {
          const token = jwt.sign({ username: user.username }, process.env.SECRET_KEY, { expiresIn: '1h' }); // jwt.sign generiert einen Token für den jeweiligen User
          //const token = jwt.sign({ username: user.username }, '123', { expiresIn: '1h' }); // jwt.sign generiert einen Token für den jeweiligen User
          res.json({ token });
      } else if (!user) {
          //console.log('User not found');
          //console.log('Used username:', username);
          res.status(401).send('Invalid credentials');
      } else {
        //console.log('Used username:', username);
        //console.log('Used password:', password);
        res.status(401).send('Invalid credentials');
      }
  } catch (err) {
      console.error(err);
      res.status(500).send('Error logging in');
  }
});

// Registriert einen Benutzter durch speichern seiner Daten in der Datenbank; Passwort wird gehashed gespeichert
/**
 * Route providing the registration for the web application
 * @name post/login
 * @async
 * @function
 * @param {Object} req - Request object
 * @param {Object} res - Response object
 * @memberof module:Login&amp;Registration~loginRouter
 * @inner
 */
router.post('/api/register', async (req, res) => {
  const { email, username, password } = req.body;
    const hashedPassword = await bcrypt.hash(password, 10);
    if (email.includes('@iu-study.org') || email.includes("@iubh.de")){
    try {
        const result = await pool.query(global.queries.register,[email, username, hashedPassword]);
        res.status(201).send(`User registered with ID: ${result.rows[0].id}`);
    } catch (err) {
      console.error(err);
        res.status(500).send('Error registering user');
    }
  } else res.status(403).send('Unathorized Domain');
  });

module.exports = router;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-Authentification-Middleware.html">Authentification-Middleware</a></li><li><a href="module-Login&Registration.html">Login&Registration</a></li><li><a href="module-PostgreSQL-Middleware.html">PostgreSQL-Middleware</a></li><li><a href="module-Quiz.html">Quiz</a></li><li><a href="module-Server.html">Server</a></li><li><a href="module-Websockets.html">Websockets</a></li><li><a href="module-Websockets-Functions.html">Websockets-Functions</a></li></ul><h3>Namespaces</h3><ul><li><a href="module-Login&Registration-loginRouter.html">loginRouter</a></li><li><a href="module-Quiz-quizRouter.html">quizRouter</a></li><li><a href="module-Websockets-Functions-RoomsState.html">RoomsState</a></li><li><a href="module-Websockets-Functions-UsersState.html">UsersState</a></li><li><a href="module-Websockets-multiPlayerQuiz.html">multiPlayerQuiz</a></li><li><a href="module-Websockets-multiPlayerQuiz-Connection.html">Connection</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Sun Mar 23 2025 11:23:55 GMT+0100 (Mitteleuropäische Normalzeit)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
